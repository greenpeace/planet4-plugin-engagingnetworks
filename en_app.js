jQuery("#en_settings_notices, #create_field_notices").on("message:add",function(e,t){var i=$("<div>",{class:t.type,text:t.message});jQuery(this).append(i),setTimeout(function(){i.remove()},5e3)}),Backbone.$.ajaxSetup({headers:{"X-WP-Nonce":p4_data.nonce}});var p4_en=function(e,t){return{api_url:t.api_url,Router:Backbone.Router.extend({routes:{questions:"showQuestions",questions_available:"showAvailable","questions/new":"newQuestion","questions/edit/:id":"editQuestion",fields:"showFields","fields/new":"newField","fields/edit/:id":"editField",fields_available:"showAvailableFields"}}),Models:{},Collections:{},Views:{},general_messages_container:"#en_settings_notices",field_messages_container:"#create_field_notices",show_loader:function(){e("#en_loader").removeClass("hidden")},hide_loader:function(){e("#en_loader").addClass("hidden")},add_message:function(t,i){e(this.general_messages_container).trigger("message:add",{message:t,type:i})},add_field_message:function(t,i){e(this.field_messages_container).trigger("message:add",{message:t,type:i})}}}(jQuery,p4_data);!function(e){"use strict";e.Models.FieldAvailable=Backbone.Model.extend({urlRoot:e.api_url+"/fields_available",defaults:{id:0,name:null,property:null,tag:""}})}(p4_en),function(e){"use strict";e.Models.QuestionAvailable=Backbone.Model.extend({urlRoot:e.api_url+"/questions_available",defaults:{id:0,name:null,questionId:0,label:""}})}(p4_en),function(e){"use strict";e.Models.Field=Backbone.Model.extend({urlRoot:e.api_url+"/fields",defaults:{id:0,name:null,label:"",default_value:"",hidden:"N"}})}(p4_en),function(e){"use strict";e.Models.Question=Backbone.Model.extend({urlRoot:e.api_url+"/questions",defaults:{id:0,name:null,questionId:0,label:"",type:null,default_value:"",hidden:"N"}})}(p4_en),function(e){"use strict";e.Collections.AvailableFieldsCollection=Backbone.Collection.extend({model:e.Models.FieldAvailable,url:e.api_url+"/fields_available",comparator:function(e){return e.get("name").toLowerCase()}})}(p4_en),function(e){"use strict";e.Collections.AvailableQuestionsCollection=Backbone.Collection.extend({model:e.Models.QuestionAvailable,url:e.api_url+"/questions_available",comparator:function(e){return e.get("type")+e.get("name").toLowerCase()}})}(p4_en),function(e){"use strict";e.Collections.FieldsCollection=Backbone.Collection.extend({model:e.Models.Field,url:e.api_url+"/fields"})}(p4_en),function(e){"use strict";e.Collections.QuestionsCollection=Backbone.Collection.extend({model:e.Models.Question,url:e.api_url+"/questions"})}(p4_en),function(e){"use strict";e.Views.AvailableFieldsListView=Backbone.View.extend({el:"#available-fields-div",bodyContainer:".available-fields-container",template:_.template($("#tmpl-en-available-fields").html()),page:0,filteredPage:0,perPage:10,totalPages:0,totalFilteredPages:0,totalFields:0,totalFilteredFields:0,start:0,end:0,filtered:null,events:{"click .reload-fields":"reload","click .loadprevious":"renderPreviousPage","click .loadnext":"renderNextPage","keyup #search_en_name":"searchName"},initialize:function(){this.listenTo(this.collection,"sync",this.render),this.listenTo(this.collection,"remove",function(){this.collection.fetch()}),this.listenTo(this.collection,"add",this.render)},renderOne:function(t){var i=new e.Views.AvailableFieldsListItemView({model:t});this.$(this.bodyContainer).append(i.render().$el)},render:function(){this.totalPages=Math.ceil(_.size(this.collection)/this.perPage),this.totalFields=_.size(this.collection);var e=this.template({col:this});return this.$el.html(e),this.renderGroup(0,this.perPage-1),this},reload:function(){e.router.navigate("fields_available",!0)},renderPagination:function(){var e=_.template($("#tmpl-fields-pagination").html())({col:this,currentPage:1});$(".available-fields-footer").html(e)},renderGroup:function(e,t){var i;null!==this.filtered?(i=this.filtered,this.end=this.filteredPage+1===this.totalFilteredPages?this.totalFilteredFields:t+1):(i=this.collection.models,this.end=this.page+1===this.totalPages?this.totalFields:t+1);var s=_.filter(i,function(i,s){return s>=e&&s<=t});return this.start=e+1,this.renderSubset(s),this},renderSubset:function(e){$(this.bodyContainer).html(""),this.renderPagination(),this.$el.find(this.bodyContainer).fadeTo("fast",.33),_.each(e,function(e){this.renderOne(e)},this),this.$el.find(this.bodyContainer).fadeTo("slow",1)},renderNextPage:function(){if(null!==this.filtered){if(this.filteredPage+1<this.totalFilteredPages){this.filteredPage++;var e=(t=this.filteredPage*this.perPage)+(this.perPage-1);this.renderGroup(t,e)}}else if(this.page+1<this.totalPages){this.page++;var t;e=(t=this.page*this.perPage)+(this.perPage-1);this.renderGroup(t,e)}},renderPreviousPage:function(){if(null!==this.filtered){if(this.filteredPage>0){this.filteredPage--;var e=(t=this.filteredPage*this.perPage)+(this.perPage-1);this.renderGroup(t,e)}}else if(this.page>0){this.page--;var t;e=(t=this.page*this.perPage)+(this.perPage-1);this.renderGroup(t,e)}},searchName:function(){var e=$("#search_en_name").val();if(""===e)return this.resetFilteredPagination(),this.render();this.resetPagination();var t=new RegExp(e,"gi"),i=this.collection.filter(function(e){return null!==e.get("name").match(t)});this.filtered=i,this.totalFilteredFields=_.size(i),this.totalFilteredPages=Math.ceil(_.size(i)/this.perPage),this.filteredPage=0;var s=this.perPage-1;this.start=1,this.end=s+1;var n=_.filter(this.filtered,function(e,t){return t>=0&&t<=s});console.log(i),this.renderSubset(n)},resetPagination:function(){this.page=0,this.totalPages=0,this.totalFields=0},resetFilteredPagination:function(){this.filtered=null,this.totalFilteredFields=0,this.totalFilteredPages=0,this.filteredPage=0}}),e.Views.AvailableFieldsListItemView=Backbone.View.extend({className:"available-field-list-item",tagName:"tr",template:_.template($("#tmpl-en-available-field").html()),events:{"click .add-field":"add"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){var e=this.template(this.model.toJSON());return this.$el.html(e),this},add:function(t){t.preventDefault();var i=new e.Views.NewFieldView({model:new e.Models.Field(this.model.toJSON())});$("#new-field-div").html(i.render().$el),$("html, body").animate({scrollTop:$("#new-field-div").offset().top},500)}})}(p4_en),function(e){"use strict";e.Views.AvailableQuestionsListView=Backbone.View.extend({el:"#existing-questions-div",template:_.template($("#tmpl-en-available-questions").html()),events:{"click .reload-questions":"reload"},initialize:function(){this.listenTo(this.collection,"sync",this.render),this.listenTo(this.collection,"remove",function(){this.collection.fetch()}),this.listenTo(this.collection,"add",this.render)},renderOne:function(t){var i=new e.Views.AvailableQuestionsListItemView({model:t});this.$(".available-questions-container").append(i.render().$el)},render:function(){var e=this.template({col:this.collection});return this.$el.html(e),this.$el.find(".available-questions-container").fadeTo("fast",.33),this.collection.each(this.renderOne,this),this.$el.find(".available-questions-container").fadeTo("slow",1),this},reload:function(){e.router.navigate("questions_available",!0)}}),e.Views.AvailableQuestionsListItemView=Backbone.View.extend({className:"question-list-item card",tagName:"li",template:_.template($("#tmpl-en-available-question").html()),events:{"click .add-question":"add"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){var e=this.template(this.model.toJSON());return this.$el.html(e),this},add:function(t){t.preventDefault();var i=new e.Views.NewQuestionView({model:new e.Models.Question(this.model.toJSON())});$("#new-question-div").html(i.render().$el),$("html, body").animate({scrollTop:$("#new-question-div").offset().top},500)}})}(p4_en),function(e){"use strict";e.Views.FieldsListView=Backbone.View.extend({el:"#stored-fields-div",template:_.template($("#tmpl-en-fields").html()),events:{"click .add-field":"addField","click .edit-field":"editField","click .reload-fields":"reload","click .cancel-field":"reload"},initialize:function(){this.listenTo(this.collection,"sync",this.render),this.listenTo(this.collection,"remove",function(){this.collection.fetch()}),this.listenTo(this.collection,"add",this.render)},renderOne:function(t){var i=new e.Views.FieldsListItemView({model:t});this.$(".fields-container").append(i.render().$el)},render:function(){var e=this.template({col:this.collection});return this.$el.html(e),$("#new-field-div").html(""),this.$el.find(".fields-container").fadeTo("fast",.33),this.collection.each(this.renderOne,this),this.$el.find(".fields-container").fadeTo("slow",1),this},reload:function(t){t.preventDefault(),e.refresh_fields()},validateFields:function(){var t=$("#en_field_name").val(),i=$("#en_field_label").val(),s=$("#en_field_id").val(),n=$("#en_field_default").val(),l=$("#en_field_hidden").is(":checked")?"Y":"N";return""===t||""===i?(e.add_field_message(["Name and Label can't be empty"].join("<br>"),"error"),!1):{id:s,name:t,label:i,hidden:l,default_value:n}},addField:function(t){t.preventDefault();var i=this.validateFields();if(!1!==i){var s=new e.Models.Field(i);e.show_loader(),s.save({},{type:"POST",url:e.api_url+"/fields",success:function(t,i,s){e.add_message("Field has been saved.","updated"),e.hide_loader(),e.refresh_fields(),e.refresh_available_fields()},error:function(t,i,s){var n=i.responseJSON.messages;e.add_field_message(n.join("<br>"),"error"),e.hide_loader()}})}},editField:function(t){t.preventDefault();var i=this.validateFields();if(!1!==i){var s=t.target,n=$(s).data("id"),l=e.fields.get(n);l.set(i),e.show_loader(),l.save({},{success:function(t,i,s){console.log("The model has been saved to the server"),e.add_message("Field has been saved.","updated"),e.hide_loader(),e.refresh_fields(),e.refresh_available_fields()},error:function(t,i,s){console.log("Something went wrong while saving the model");var n=i.responseJSON;e.add_field_message(n.messages.join("<br>"),"error"),e.hide_loader()}})}}}),e.Views.FieldsListItemView=Backbone.View.extend({className:"field-list-item",tagName:"tr",template:_.template($("#tmpl-en-field").html()),events:{"click .edit-this-field":"edit","click .delete-field":"delete"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=this.template(this.model.toJSON());return this.$el.html(e),this},edit:function(t){t.preventDefault();var i=new e.Views.NewFieldView({model:this.model});$("#new-field-div").html(i.render().$el),$("html, body").animate({scrollTop:$("#new-field-div").offset().top},500)},delete:function(t){t.preventDefault(),e.show_loader(),this.model.destroy({success:function(t,i,s){e.add_message("Field has been deleted","updated")},error:function(t,i,s){var n=i.responseJSON;e.add_message(n.messages.join("<br>"),"error")},wait:!0}).then(function(){e.hide_loader(),e.refresh_fields(),e.refresh_available_fields()})}}),e.Views.NewFieldView=Backbone.View.extend({tagName:"div",template:_.template($("#tmpl-new-en-field").html()),initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=this.template(this.model.toJSON());return this.$el.html(e),this}})}(p4_en),function(e){"use strict";e.Views.QuestionsListView=Backbone.View.extend({el:"#selected-questions-div",template:_.template($("#tmpl-en-questions").html()),events:{"click .create-question":"addQuestion","click .edit-question":"editQuestion","click .reload-questions":"reload","click .cancel-question":"reload"},initialize:function(){this.listenTo(this.collection,"sync",this.render),this.listenTo(this.collection,"remove",function(){this.collection.fetch()}),this.listenTo(this.collection,"add",this.render)},renderOne:function(t){var i=new e.Views.QuestionsListItemView({model:t});this.$(".questions-container").append(i.render().$el)},render:function(){var e=this.template({col:this.collection});return this.$el.html(e),$("#new-question-div").html(""),this.$el.find(".questions-container").fadeTo("fast",.33),this.collection.each(this.renderOne,this),this.$el.find(".questions-container").fadeTo("slow",1),this},reload:function(t){t.preventDefault(),e.refresh_data()},validateFields:function(){var e=$("#en_question_name").val(),t=$("#en_question_label").val(),i=$("#en_question_type").val(),s=$("#en_question_id").val(),n=$("#en_question__id").val(),l="";$("#en_question_default").length>0?l=$("#en_question_default").val():$("input[name='en_question_default']").length>0&&(l=$("input[name='en_question_default']:checked").val());var a=$("#en_question_hidden").is(":checked")?"Y":"N";return""===e||""===t?(alert("Name and Question can't be empty"),!1):{id:s,name:e,label:t,type:i,questionId:n,hidden:a,default_value:l}},addQuestion:function(t){t.preventDefault();var i=this.validateFields();if(!1!==i){var s=new e.Models.Question(i);e.show_loader(),s.save({},{type:"POST",url:e.api_url+"/questions",success:function(){e.add_message("Question has been saved.","updated"),e.hide_loader(),e.refresh_data()},error:function(t,i){var s=i.responseJSON.messages;e.add_message(s.join("<br>"),"error"),e.hide_loader()}})}},editQuestion:function(t){t.preventDefault();var i=this.validateFields();if(!1!==i){var s=e.questions.get(i.id);s.set(i),e.show_loader(),s.save({},{success:function(){console.log("The model has been saved to the server"),e.add_message("Question has been saved.","updated"),e.hide_loader(),e.refresh_data()},error:function(t,i){console.log("Something went wrong while saving the model");var s=i.responseJSON;e.add_message(s.messages.join("<br>"),"error"),e.hide_loader()}})}}}),e.Views.QuestionsListItemView=Backbone.View.extend({className:"question-list-item card",tagName:"li",template:_.template($("#tmpl-en-question").html()),events:{"click .edit-this-question":"edit","click .delete-question":"delete"},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=this.template(this.model.toJSON());return this.$el.html(e),this},edit:function(t){t.preventDefault();var i=new e.Views.NewQuestionView({model:this.model});$("#new-question-div").html(i.render().$el),$("html, body").animate({scrollTop:$("#new-question-div").offset().top},500)},delete:function(t){t.preventDefault(),e.show_loader(),this.model.destroy({success:function(t,i,s){e.add_message("Question has been deleted","updated")},error:function(t,i,s){var n=i.responseJSON;e.add_message(n.messages.join("<br>"),"error")},wait:!0}).then(function(){e.hide_loader(),e.refresh_data()})}}),e.Views.NewQuestionView=Backbone.View.extend({tagName:"div",template:_.template($("#tmpl-new-en-question").html()),initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var e=this.template(this.model.toJSON());return this.$el.html(e),this}})}(p4_en);